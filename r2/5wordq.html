<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국어 어휘 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            overscroll-behavior: none; /* 스크롤 당김 효과 제거 */
        }
        /* 커스텀 스크롤바 (결과 창용) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- 사용자 이름 입력 화면 -->
    <div id="login-screen" class="w-full max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl">
        <h2 class="text-3xl font-bold text-center text-blue-700 mb-6">한국어 어휘 퀴즈</h2>
        <p class="text-center text-gray-600 mb-8">퀴즈 기록을 저장할 이름을 입력해 주세요.</p>
        <div class="mb-4">
            <label for="user-name-input" class="block text-sm font-medium text-gray-700 mb-2">이름</label>
            <input type="text" id="user-name-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="이름 (2글자 이상)">
        </div>
        <button id="login-button" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-lg">
            퀴즈 시작하기
        </button>
    </div>

    <!-- 퀴즈 메인 화면 (처음에는 숨김) -->
    <div id="quiz-container" class="hidden w-full max-w-4xl mx-auto flex flex-col md:flex-row gap-6">
        <!-- 퀴즈 영역 -->
        <div class="w-full md:w-2/3 bg-white p-6 md:p-8 rounded-2xl shadow-xl transition-all duration-300">
            
            <!-- 퀴즈 진행 화면 -->
            <div id="quiz-progress-screen">
                <h2 id="user-greeting" class="text-xl font-semibold text-gray-700 mb-6"></h2>
                
                <!-- 질문 표시 -->
                <div id="question-container" class="mb-6 min-h-[100px]">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold text-gray-700">문제 <span id="question-number">1</span> / <span id="total-questions">16</span></span>
                        <!-- 'question-word'를 표시하던 span을 숨김 처리 (hidden 클래스 추가) -->
                        <span id="question-word" class="hidden text-xl md:text-2xl font-bold text-blue-700 bg-blue-50 p-2 rounded-lg"></span>
                    </div>
                    <p id="question-text" class="text-lg md:text-xl text-gray-800 leading-relaxed"></p>
                </div>

                <!-- 선택지 버튼 -->
                <div id="options-container" class="grid grid-cols-1 gap-4 mb-6">
                    <!-- JavaScript로 버튼 생성 -->
                </div>

                <!-- 제출 버튼 -->
                <button id="submit-btn" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-lg disabled:bg-gray-400">
                    채점하기
                </button>
            </div>

            <!-- 퀴즈 결과 화면 -->
            <div id="result-screen" class="hidden">
                <h2 class="text-3xl font-bold text-center text-blue-800 mb-4">퀴즈 결과</h2>
                <p id="score-text" class="text-5xl font-bold text-center text-gray-800 mb-6">100점</p>
                <div id="feedback-container" class="space-y-4 mb-6 max-h-60 overflow-y-auto custom-scrollbar p-4 bg-gray-50 rounded-lg">
                    <!-- 피드백 내용 -->
                </div>
                <div class="flex gap-4">
                    <button id="retry-btn" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                        다시 풀기
                    </button>
                    <button id="next-btn" class="flex-1 bg-gray-700 text-white px-4 py-3 rounded-lg font-semibold hover:bg-gray-800 transition duration-300">
                        다음 문제
                    </button>
                </div>
            </div>

        </div>

        <!-- 이전 결과 영역 -->
        <div id="prev-results-container" class="w-full md:w-1/3 bg-white p-6 md:p-8 rounded-2xl shadow-xl">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">이전 퀴즈 기록</h3>
            <div id="prev-results-list" class="space-y-4 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                <!-- 이전 결과가 여기에 표시됩니다. -->
                <p id="no-results-text" class="text-gray-500">아직 퀴즈 기록이 없습니다.</p>
            </div>
        </div>
    </div>

    <!-- 맞춤형 알림/모달 창 -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <p id="modal-message" class="text-lg text-gray-800 mb-6"></p>
            <button id="modal-close-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                확인
            </button>
        </div>
    </div>

    <script>
        // 퀴즈 데이터 (속담 및 관용어)
        const quizData = [
            // --- 속담 (Proverbs) ---
            {
                word: "콩 심은 데 콩 난다",
                question: "다음 중 '콩 심은 데 콩 난다' 속담을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "열심히 공부했더니 시험을 잘 봤어요.", 
                    "자전거를 잃어버린 후에 자물쇠를 샀어요.", 
                    "요리사가 요리하다가 음식을 태웠어요.", 
                    "엄마와 아빠가 싸우는데 나만 혼났어요."
                ],
                answer: "열심히 공부했더니 시험을 잘 봤어요.",
                feedback: "'콩 심은 데 콩 난다'는 원인대로 결과가 나온다는 뜻입니다. 열심히 노력했으니 좋은 결과가 나온 상황에 씁니다."
            },
            {
                word: "개구리 올챙이 적 생각 못 한다",
                question: "다음 중 '개구리 올챙이 적 생각 못 한다' 속담을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "부자가 된 후에, 가난했던 때를 잊고 다른 사람을 무시해요.", 
                    "어릴 때부터 손톱을 물어뜯었는데, 어른이 되어서도 고치기 어려워요.", 
                    "가장 친한 친구가 내 비밀을 다른 사람에게 말했어요.", 
                    "요리사가 요리하다가 음식을 태웠어요."
                ],
                answer: "부자가 된 후에, 가난했던 때를 잊고 다른 사람을 무시해요.",
                feedback: "'개구리 올챙이 적 생각 못 한다'는 자신이 부족했던 옛날을 잊어버리고 잘난 척하는 상황에 씁니다."
            },
            {
                word: "소 잃고 외양간 고친다",
                question: "다음 중 '소 잃고 외양간 고친다' 속담을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "자전거를 잃어버린 후에 자물쇠를 샀어요.", 
                    "열심히 공부했더니 시험을 잘 봤어요.", 
                    "회사에서 혼나고 집에 와서 동생에게 화를 냈어요.", 
                    "엄마와 아빠가 싸우는데 나만 혼났어요."
                ],
                answer: "자전거를 잃어버린 후에 자물쇠를 샀어요.",
                feedback: "'소 잃고 외양간 고친다'는 일이 이미 잘못된 후에 고치려고 해서 소용이 없는 상황에 씁니다."
            },
            {
                word: "고래 싸움에 새우 등 터진다",
                question: "다음 중 '고래 싸움에 새우 등 터진다' 속담을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "엄마와 아빠가 싸우는데, 잘못 없는 나만 혼났어요.", 
                    "가장 친한 친구가 내 비밀을 다른 사람에게 말했어요.", 
                    "부자가 된 후에, 가난했던 때를 잊고 다른 사람을 무시해요.", 
                    "열심히 공부했더니 시험을 잘 봤어요."
                ],
                answer: "엄마와 아빠가 싸우는데, 잘못 없는 나만 혼났어요.",
                feedback: "'고래 싸움에 새우 등 터진다'는 힘이 센 사람들 싸움에 약한 사람이 피해를 보는 상황에 씁니다."
            },
            {
                word: "세 살 버릇 여든까지 간다",
                question: "다음 중 '세 살 버릇 여든까지 간다' 속담을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "어릴 때부터 손톱을 물어뜯었는데, 어른이 되어서도 고치기 어려워요.", 
                    "요리사가 요리하다가 음식을 태웠어요.", 
                    "자전거를 잃어버린 후에 자물쇠를 샀어요.", 
                    "가장 친한 친구가 내 비밀을 다른 사람에게 말했어요."
                ],
                answer: "어릴 때부터 손톱을 물어뜯었는데, 어른이 되어서도 고치기 어려워요.",
                feedback: "'세 살 버릇 여든까지 간다'는 어릴 때 생긴 나쁜 습관은 고치기 어렵다는 뜻입니다."
            },
            {
                word: "믿는 도끼에 발등 찍힌다",
                question: "다음 중 '믿는 도끼에 발등 찍힌다' 속담을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "가장 친한 친구가 내 비밀을 다른 사람에게 말했어요.", 
                    "엄마와 아빠가 싸우는데, 잘못 없는 나만 혼났어요.", 
                    "열심히 공부했더니 시험을 잘 봤어요.", 
                    "부자가 된 후에, 가난했던 때를 잊고 다른 사람을 무시해요."
                ],
                answer: "가장 친한 친구가 내 비밀을 다른 사람에게 말했어요.",
                feedback: "'믿는 도끼에 발등 찍힌다'는 내가 믿었던 사람에게 배신을 당한 상황에 씁니다."
            },
            {
                word: "원숭이도 나무에서 떨어진다",
                question: "다음 중 '원숭이도 나무에서 떨어진다' 속담을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "매일 요리하는 요리사가 오늘 음식을 태웠어요.", 
                    "어릴 때부터 생긴 나쁜 습관을 고치기 어려워요.", 
                    "자전거를 잃어버린 후에 자물쇠를 샀어요.", 
                    "회사에서 혼나고 집에 와서 동생에게 화를 냈어요."
                ],
                answer: "매일 요리하는 요리사가 오늘 음식을 태웠어요.",
                feedback: "'원숭이도 나무에서 떨어진다'는 아무리 잘하는 사람도 실수할 수 있다는 뜻입니다."
            },
            {
                word: "종로에서 뺨 맞고 한강에서 화풀이한다",
                question: "다음 중 '종로에서 뺨 맞고 한강에서 화풀이한다' 속담을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "회사에서 상사에게 혼나고, 집에 와서 동생에게 화를 냈어요.", 
                    "가장 친한 친구가 내 비밀을 다른 사람에게 말했어요.", 
                    "부자가 된 후에, 가난했던 때를 잊고 다른 사람을 무시해요.", 
                    "엄마와 아빠가 싸우는데, 잘못 없는 나만 혼났어요."
                ],
                answer: "회사에서 상사에게 혼나고, 집에 와서 동생에게 화를 냈어요.",
                feedback: "'종로에서 뺨 맞고 한강에서 화풀이한다'는 다른 곳에서 생긴 화를 관계없는 사람에게 푸는 상황에 씁니다."
            },

            // --- 관용어 (Idioms) ---
            {
                word: "손이 모자라다",
                question: "다음 중 '손이 모자라다' 표현을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "식당에 손님이 너무 많아서 일할 사람이 더 필요해요.", 
                    "그 사람은 1시간 걸릴 일을 30분 만에 끝냈어요.", 
                    "어디를 가도 아는 사람이 정말 많아요.", 
                    "음식을 조금만 하려고 했는데, 항상 너무 많이 만들어요."
                ],
                answer: "식당에 손님이 너무 많아서 일할 사람이 더 필요해요.",
                feedback: "'손이 모자라다'는 일할 사람이 부족하다는 뜻입니다."
            },
            {
                word: "손이 빠르다",
                question: "다음 중 '손이 빠르다' 표현을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "그 사람은 1시간 걸릴 일을 30분 만에 끝냈어요.", 
                    "비밀 이야기를 해도 다른 사람에게 절대 말하지 않아요.", 
                    "다른 사람의 말을 너무 쉽게 믿고, 물건을 금방 사요.", 
                    "지금 당장 여행을 떠나고 싶어요."
                ],
                answer: "그 사람은 1시간 걸릴 일을 30분 만에 끝냈어요.",
                feedback: "'손이 빠르다'는 일을 아주 빨리 잘한다는 뜻입니다."
            },
            {
                word: "발이 넓다",
                question: "다음 중 '발이 넓다' 표현을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "그 사람은 어디를 가도 아는 사람이 정말 많아요.", 
                    "식당에 손님이 너무 많아서 일할 사람이 더 필요해요.", 
                    "쇼핑을 오래 했지만, 마음에 드는 옷이 하나도 없어요.", 
                    "음식을 조금만 하려고 했는데, 항상 너무 많이 만들어요."
                ],
                answer: "그 사람은 어디를 가도 아는 사람이 정말 많아요.",
                feedback: "'발이 넓다'는 아는 사람이 많고 사람들과 관계가 좋다는 뜻입니다."
            },
            {
                word: "손이 크다",
                question: "다음 중 '손이 크다' 표현을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "음식을 조금만 하려고 했는데, 항상 너무 많이 만들어요.", 
                    "비밀 이야기를 해도 다른 사람에게 절대 말하지 않아요.", 
                    "그 사람은 1시간 걸릴 일을 30분 만에 끝냈어요.", 
                    "일할 사람이 부족해서 도움이 필요해요."
                ],
                answer: "음식을 조금만 하려고 했는데, 항상 너무 많이 만들어요.",
                feedback: "'손이 크다'는 돈이나 물건을 아끼지 않고 넉넉하게 쓰거나, 음식을 많이 만드는 사람에게 씁니다."
            },
            {
                word: "입이 무겁다",
                question: "다음 중 '입이 무겁다' 표현을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "그 사람에게 비밀 이야기를 해도 절대 다른 사람에게 말하지 않아요.", 
                    "다른 사람의 말을 너무 쉽게 믿고, 물건을 금방 사요.", 
                    "그 사람은 어디를 가도 아는 사람이 정말 많아요.", 
                    "지금 당장 여행을 떠나고 싶어요."
                ],
                answer: "그 사람에게 비밀 이야기를 해도 절대 다른 사람에게 말하지 않아요.",
                feedback: "'입이 무겁다'는 비밀을 잘 지키는 사람을 말합니다."
            },
            {
                word: "귀가 얇다",
                question: "다음 중 '귀가 얇다' 표현을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "다른 사람의 말을 너무 쉽게 믿고, 물건을 금방 사요.", 
                    "비밀 이야기를 해도 다른 사람에게 절대 말하지 않아요.", 
                    "쇼핑을 오래 했지만, 마음에 드는 옷이 하나도 없어요.", 
                    "그 사람은 1시간 걸릴 일을 30분 만에 끝냈어요."
                ],
                answer: "다른 사람의 말을 너무 쉽게 믿고, 물건을 금방 사요.",
                feedback: "'귀가 얇다'는 다른 사람의 말을 쉽게 믿는다는 뜻입니다."
            },
            {
                word: "마음이 굴뚝같다",
                question: "다음 중 '마음이 굴뚝같다' 표현을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "지금 당장 여행을 떠나고 싶은 마음이 아주 커요.", 
                    "일할 사람이 부족해서 도움이 필요해요.", 
                    "그 사람은 어디를 가도 아는 사람이 정말 많아요.", 
                    "다른 사람의 말을 너무 쉽게 믿어요."
                ],
                answer: "지금 당장 여행을 떠나고 싶은 마음이 아주 커요.",
                feedback: "'마음이 굴뚝같다'는 어떤 것을 아주 간절하게 하고 싶다는 뜻입니다."
            },
            {
                word: "눈에 차다",
                question: "다음 중 '눈에 차다' 표현을 사용하기 좋은 상황은 무엇인가요?",
                options: [
                    "쇼핑을 오래 했지만, 마음에 드는 옷이 하나도 없어요.", 
                    "음식을 조금만 하려고 했는데, 항상 너무 많이 만들어요.", 
                    "비밀 이야기를 해도 다른 사람에게 절대 말하지 않아요.", 
                    "일할 사람이 부족해서 도움이 필요해요."
                ],
                answer: "쇼핑을 오래 했지만, 마음에 드는 옷이 하나도 없어요.",
                feedback: "'눈에 차다'는 마음에 들어서 만족스럽다는 뜻입니다. (예: 눈에 차는 옷이 없다 = 마음에 드는 옷이 없다)"
            }
        ];

        // 퀴즈 상태 변수
        let currentUserName = '';
        let currentQuestionIndex = 0;
        let userAnswers = {}; // { 0: "선택한답", 1: "선택한답" }
        let quizState = 'progress'; // 'progress' | 'feedback'

        // HTML 요소 가져오기
        const loginScreen = document.getElementById('login-screen');
        const userNameInput = document.getElementById('user-name-input');
        const loginButton = document.getElementById('login-button');
        
        const quizContainer = document.getElementById('quiz-container');
        const userGreeting = document.getElementById('user-greeting');
        
        const quizProgressScreen = document.getElementById('quiz-progress-screen');
        const questionContainer = document.getElementById('question-container');
        const questionNumberEl = document.getElementById('question-number');
        const questionWordEl = document.getElementById('question-word');
        const totalQuestionsEl = document.getElementById('total-questions');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const submitBtn = document.getElementById('submit-btn');

        const resultScreen = document.getElementById('result-screen');
        const scoreTextEl = document.getElementById('score-text');
        const feedbackContainer = document.getElementById('feedback-container');
        const retryBtn = document.getElementById('retry-btn');
        const nextBtn = document.getElementById('next-btn');

        const prevResultsContainer = document.getElementById('prev-results-container');
        const prevResultsList = document.getElementById('prev-results-list');
        const noResultsText = document.getElementById('no-results-text');

        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // 모달창 기능
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        // 사용자 로그인 처리
        function handleLogin() {
            const userName = userNameInput.value.trim();
            if (userName.length < 2) {
                showModal("이름을 2글자 이상 입력해 주세요.");
                return;
            }
            
            currentUserName = userName;
            loginScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            
            userGreeting.textContent = `${currentUserName}님, 환영합니다!`;
            
            // 이 사용자의 이전 결과 불러오기
            loadPreviousResults();
            
            // 퀴즈 시작
            startQuiz();
        }

        // 이전 결과 불러오기 (localStorage)
        function loadPreviousResults() {
            if (!currentUserName) return;
            
            const resultsKey = `koreanQuizResults_${currentUserName}`;
            try {
                const resultsRaw = localStorage.getItem(resultsKey);
                const results = resultsRaw ? JSON.parse(resultsRaw) : [];
                renderPreviousResults(results);
            } catch (error) {
                console.error("이전 결과 불러오기 실패 (localStorage): ", error);
                renderPreviousResults([]); // 오류 발생 시 빈 목록 표시
            }
        }

        // 이전 결과 UI 렌더링
        function renderPreviousResults(results) {
            prevResultsList.innerHTML = ''; // 목록 초기화
            if (results.length === 0) {
                noResultsText.classList.remove('hidden');
            } else {
                noResultsText.classList.add('hidden');
                
                // 최신 결과가 위로 오도록 정렬 (원본 배열을 바꾸지 않기 위해 slice() 사용)
                const sortedResults = results.slice().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                sortedResults.forEach(data => {
                    const date = new Date(data.timestamp).toLocaleString('ko-KR');
                    const scoreColor = data.score === data.total ? 'text-blue-600' : 'text-red-600';

                    const resultEl = document.createElement('div');
                    resultEl.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                    resultEl.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold ${scoreColor}">점수: ${data.score} / ${data.total}</span>
                        </div>
                        <span class="text-xs text-gray-500">${date}</span>
                    `;
                    prevResultsList.appendChild(resultEl);
                });
            }
        }

        // 퀴즈 결과 저장 (localStorage)
        function saveQuizResult(score, total, feedback) {
            if (!currentUserName) return; // 사용자가 없으면 저장 안 함

            const newResult = {
                userName: currentUserName,
                score: score,
                total: total,
                feedback: feedback.map(f => ({ q: f.question, a: f.answer })), // 간단하게 저장
                timestamp: new Date().toISOString() // ISO 문자열로 저장
            };

            const resultsKey = `koreanQuizResults_${currentUserName}`;
            try {
                const prevResultsRaw = localStorage.getItem(resultsKey);
                const prevResults = prevResultsRaw ? JSON.parse(prevResultsRaw) : [];
                
                prevResults.push(newResult);
                
                // localStorage에 저장
                localStorage.setItem(resultsKey, JSON.stringify(prevResults));
                
                // UI 업데이트
                renderPreviousResults(prevResults);
            } catch (error) {
                console.error("결과 저장 실패 (localStorage): ", error);
            }
        }

        // 배열 섞기 함수 (Fisher-Yates Shuffle)
        function shuffleArray(array) {
            let currentIndex = array.length,  randomIndex;
            
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;

                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // 퀴즈 시작 함수
        function startQuiz() {
            currentQuestionIndex = 0;
            userAnswers = {};
            quizState = 'progress';
            totalQuestionsEl.textContent = quizData.length;

            resultScreen.classList.add('hidden');
            quizProgressScreen.classList.remove('hidden');
            
            submitBtn.textContent = '채점하기';
            submitBtn.disabled = true;

            shuffleArray(quizData); // 퀴즈 문제 순서 섞기
            renderQuestion();
        }

        // 질문 렌더링
        function renderQuestion() {
            if (currentQuestionIndex < 0 || currentQuestionIndex >= quizData.length) {
                console.error("유효하지 않은 질문 인덱스:", currentQuestionIndex);
                return;
            }
            
            const question = quizData[currentQuestionIndex];
            
            questionNumberEl.textContent = currentQuestionIndex + 1;
            questionTextEl.textContent = question.question;
            // 'question-word'를 업데이트하는 코드 제거
            
            optionsContainer.innerHTML = '';

            // --- 선택지 순서 섞기 ---
            const shuffledOptions = [...question.options];
            shuffleArray(shuffledOptions);
            // --- ---
            
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'w-full text-left p-4 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-400 transition duration-200 text-gray-700';
                
                // 사용자가 이전에 선택한 답이 있으면 표시
                if (userAnswers[currentQuestionIndex] === option) {
                    button.classList.add('bg-blue-100', 'border-blue-500', 'font-semibold');
                }

                button.addEventListener('click', () => selectOption(button, option));
                optionsContainer.appendChild(button);
            });

            submitBtn.disabled = userAnswers[currentQuestionIndex] === undefined;
            
            // 마지막 문제인지 확인
            if (currentQuestionIndex === quizData.length - 1) {
                submitBtn.textContent = '최종 결과 보기';
            } else {
                submitBtn.textContent = '채점하기';
            }
            quizState = 'progress';
        }

        // 선택지 선택
        function selectOption(selectedButton, option) {
            // 'feedback' 상태일 때는 선택 변경 불가
            if (quizState === 'feedback') return;

            // 모든 버튼의 선택 스타일 제거
            Array.from(optionsContainer.children).forEach(btn => {
                btn.classList.remove('bg-blue-100', 'border-blue-500', 'font-semibold');
            });

            // 클릭한 버튼에만 스타일 적용
            selectedButton.classList.add('bg-blue-100', 'border-blue-500', 'font-semibold');
            
            userAnswers[currentQuestionIndex] = option;
            submitBtn.disabled = false;
        }

        // 채점하기 버튼 클릭
        function submitQuiz() {
            if (quizState === 'feedback') return; // 이미 피드백 상태면 무시
            if (userAnswers[currentQuestionIndex] === undefined) return; // 답을 선택하지 않았으면 무시

            quizState = 'feedback';
            const question = quizData[currentQuestionIndex];
            const selectedAnswer = userAnswers[currentQuestionIndex];
            const isCorrect = (selectedAnswer === question.answer);

            // 모든 선택지 버튼 비활성화 및 정답/오답 표시
            Array.from(optionsContainer.children).forEach(btn => {
                btn.disabled = true;
                const optionText = btn.textContent;

                if (optionText === question.answer) {
                    // 정답
                    btn.classList.add('bg-green-100', 'border-green-500', 'ring-2', 'ring-green-400');
                    btn.classList.remove('bg-blue-100', 'border-blue-500');
                } else if (optionText === selectedAnswer && !isCorrect) {
                    // 사용자가 선택한 오답
                    btn.classList.add('bg-red-100', 'border-red-500', 'ring-2', 'ring-red-400');
                    btn.classList.remove('bg-blue-100', 'border-blue-500');
                } else {
                    // 선택하지 않은 오답
                    btn.classList.add('bg-gray-50', 'text-gray-500');
                }
            });

            // 결과 화면 표시
            quizProgressScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');

            feedbackContainer.innerHTML = ''; // 피드백 컨테이너 초기화
            
            const feedbackTitle = document.createElement('h3');
            feedbackTitle.className = 'text-xl font-bold mb-2';
            
            const feedbackText = document.createElement('p');
            feedbackText.className = 'text-gray-700';
            feedbackText.textContent = question.feedback;

            if (isCorrect) {
                feedbackTitle.textContent = '정답입니다! 🎉';
                feedbackTitle.className += ' text-green-700';
                scoreTextEl.textContent = '정답!';
                scoreTextEl.className = 'text-5xl font-bold text-center text-green-600 mb-6';
            } else {
                feedbackTitle.textContent = '틀렸습니다.';
                feedbackTitle.className += ' text-red-700';
                feedbackContainer.appendChild(feedbackTitle);
                
                const yourAnswerEl = document.createElement('p');
                yourAnswerEl.className = 'text-sm text-gray-600';
                yourAnswerEl.innerHTML = `<b>내가 선택한 답:</b> ${selectedAnswer}`;
                feedbackContainer.appendChild(yourAnswerEl);
                
                const correctAnswerEl = document.createElement('p');
                correctAnswerEl.className = 'text-sm text-gray-600 mb-2';
                correctAnswerEl.innerHTML = `<b>정답:</b> ${question.answer}`;
                feedbackContainer.appendChild(correctAnswerEl);
                
                scoreTextEl.textContent = '오답';
                scoreTextEl.className = 'text-5xl font-bold text-center text-red-600 mb-6';
            }
            
            feedbackContainer.appendChild(feedbackTitle);
            feedbackContainer.appendChild(feedbackText);

            // 버튼 설정
            retryBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');

            if (currentQuestionIndex === quizData.length - 1) {
                // 마지막 문제인 경우
                nextBtn.textContent = '최종 점수 보기';
            } else {
                nextBtn.textContent = '다음 문제';
            }
        }

        // 다음 문제 버튼 / 최종 점수 보기 버튼
        function nextQuestion() {
            if (currentQuestionIndex === quizData.length - 1) {
                // 최종 점수 계산 및 표시
                showFinalResults();
            } else {
                // 다음 문제로 이동
                currentQuestionIndex++;
                quizProgressScreen.classList.remove('hidden');
                resultScreen.classList.add('hidden');
                renderQuestion();
            }
        }

        // 최종 결과 표시
        function showFinalResults() {
            let score = 0;
            const detailedFeedback = [];

            quizData.forEach((question, index) => {
                const selected = userAnswers[index];
                const correct = question.answer;
                const isCorrect = (selected === correct);
                if (isCorrect) {
                    score++;
                }
                detailedFeedback.push({
                    question: question.question,
                    selected: selected || "선택 안 함",
                    answer: correct,
                    isCorrect: isCorrect,
                    feedback: question.feedback
                });
            });

            const total = quizData.length;
            const finalScorePercent = Math.round((score / total) * 100);
            
            quizProgressScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');

            scoreTextEl.textContent = `${finalScorePercent}점`;
            scoreTextEl.className = 'text-5xl font-bold text-center text-blue-800 mb-6';

            feedbackContainer.innerHTML = `<h3 class="text-xl font-bold mb-4 text-gray-800">전체 문제 다시보기 (${score} / ${total} 정답)</h3>`;

            detailedFeedback.forEach((fb, index) => {
                const fbEl = document.createElement('div');
                fbEl.className = `p-3 rounded-lg mb-3 ${fb.isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
                fbEl.innerHTML = `
                    <p class="font-semibold text-gray-700 mb-1">${index + 1}. ${fb.question}</p>
                    ${fb.isCorrect ? `
                        <p class="text-sm text-green-700"><b>정답:</b> ${fb.answer}</p>
                    ` : `
                        <p class="text-sm text-red-700"><b>내가 선택한 답:</b> ${fb.selected}</p>
                        <p class="text-sm text-green-700"><b>정답:</b> ${fb.answer}</p>
                    `}
                    <p class="text-xs text-gray-600 mt-1">${fb.feedback}</p>
                `;
                feedbackContainer.appendChild(fbEl);
            });
            
            // 버튼 변경
            nextBtn.classList.add('hidden');
            retryBtn.classList.remove('hidden');
            retryBtn.textContent = '새로운 퀴즈 풀기';

            // 결과 저장
            saveQuizResult(score, total, detailedFeedback);
        }

        // 다시 풀기 버튼
        function retryQuiz() {
            startQuiz();
        }

        // DOM 로드 완료 후 이벤트 리스너 설정
        document.addEventListener('DOMContentLoaded', () => {
            // 모든 요소가 로드되었는지 확인
            if (loginButton && submitBtn && nextBtn && retryBtn && modalCloseBtn && userNameInput) {
                // 로그인 버튼
                loginButton.addEventListener('click', handleLogin);
                
                // 이름 입력창에서 Enter 키로 로그인
                userNameInput.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') {
                        handleLogin();
                    }
                });

                // 퀴즈 버튼
                submitBtn.addEventListener('click', submitQuiz);
                nextBtn.addEventListener('click', nextQuestion);
                retryBtn.addEventListener('click', retryQuiz);
                
                // 모달 닫기 버튼
                modalCloseBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
            } else {
                console.error("퀴즈 앱 초기화에 실패했습니다. HTML 요소를 찾을 수 없습니다.");
            }
        });
    </script>
</body>
</html>


