<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì–´ ì–´íœ˜ í€´ì¦ˆ (v3 - ê²Œì„ í¬í•¨)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì ìš© */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* í™”ë©´ ì „í™˜ì„ ìœ„í•œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .screen {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  í™”ë©´ ìˆ¨ê¹€ */
        }
        .screen.active {
            display: block; /* active í´ë˜ìŠ¤ê°€ ìˆëŠ” í™”ë©´ë§Œ í‘œì‹œ */
        }
        /* ì»¤ìŠ¤í…€ ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .option-label {
            transition: all 0.2s ease-in-out;
        }
        .option-input:checked + .option-label {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            border-color: #3b82f6; /* border-blue-500 */
        }
        /* ì •ë‹µ/ì˜¤ë‹µ í”¼ë“œë°± ìŠ¤íƒ€ì¼ */
        .feedback-correct {
            background-color: #d1fae5; /* bg-green-100 */
            border-left: 4px solid #10b981; /* border-green-500 */
        }
        .feedback-incorrect {
            background-color: #fee2e2; /* bg-red-100 */
            border-left: 4px solid #ef4444; /* border-red-500 */
        }
        /* ê·¸ë£¹í•‘ ê²Œì„ ìŠ¤íƒ€ì¼ */
        .game-card {
            transition: all 0.2s ease-in-out;
        }
        .game-card.selected {
            background-color: #93c5fd; /* bg-blue-300 */
            transform: scale(1.05);
            ring: 2px solid #3b82f6;
        }
        .game-card.assigned {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #9ca3af; /* text-gray-400 */
            text-decoration: line-through;
            cursor: not-allowed;
        }
        .game-bucket {
            transition: all 0.2s ease-in-out;
            min-height: 120px;
        }
        .game-bucket:hover {
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .game-bucket-card {
            cursor: pointer;
        }
        .game-bucket-card:hover {
            text-decoration: line-through;
            color: #ef4444; /* text-red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen py-8">

    <div class="container w-full max-w-2xl mx-auto p-4 md:p-8 bg-white shadow-2xl rounded-lg">

        <!-- 1. ë©”ì¸ í™”ë©´ -->
        <div id="main-screen" class="screen active text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">í•œêµ­ì–´ ì–´íœ˜ í€´ì¦ˆ</h1>
            <p class="text-lg text-gray-700 mb-8">ì—°ìŠµ 1~3ì˜ ì–´íœ˜ë¥¼ ë³µìŠµí•´ ë´…ì‹œë‹¤.</p>
            <button id="start-quiz-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-300 shadow-md">
                í€´ì¦ˆ ì‹œì‘í•˜ê¸°
            </button>
            <button id="show-history-btn" class="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg text-xl transition duration-300">
                í€´ì¦ˆ ê¸°ë¡ ë³´ê¸°
            </button>
            <div id="history-container" class="mt-6 text-left hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">í€´ì¦ˆ ê¸°ë¡</h2>
                <div id="history-list" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- ê¸°ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <button id="clear-history-btn" class="w-full mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    ê¸°ë¡ ëª¨ë‘ ì‚­ì œ
                </button>
            </div>
            <!-- ìƒì„¸ ê¸°ë¡ ëª¨ë‹¬ -->
            <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-xl max-h-[80vh] overflow-hidden">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-xl font-bold">ìƒì„¸ ê¸°ë¡</h3>
                        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div id="modal-content" class="p-6 overflow-y-auto max-h-[calc(80vh-120px)]">
                        <!-- ìƒì„¸ í”¼ë“œë°±ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="p-4 border-t bg-gray-50 text-right">
                        <button id="close-modal-btn-bottom" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. í€´ì¦ˆ í™”ë©´ -->
        <div id="quiz-screen" class="screen">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-semibold text-blue-600">ë¬¸ì œ <span id="question-number">1</span> / <span id="total-questions">11</span></span>
                    <!-- íŒíŠ¸ ë²„íŠ¼ê³¼ í…ìŠ¤íŠ¸ -->
                    <div class="text-right">
                        <button id="hint-btn" class="text-sm font-medium bg-yellow-300 hover:bg-yellow-400 text-yellow-800 px-3 py-1 rounded-full transition duration-300 shadow-sm">
                            ğŸ’¡ íŒíŠ¸ ë³´ê¸°
                        </button>
                        <span id="hint-text" class="hidden text-sm font-semibold text-yellow-800 bg-yellow-100 px-3 py-1 rounded-full ml-2"></span>
                    </div>
                </div>
                <!-- ì§„í–‰ë¥  ë°” -->
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <h2 id="question-text" class="text-xl md:text-2xl font-semibold text-gray-900 mb-6 min-h-[60px]"></h2>
            
            <!-- 4ì§€ì„ ë‹¤/OX ì„ íƒì§€ ì˜ì—­ -->
            <div id="options-container" class="space-y-3"></div>
            <div id="ox-options-container" class="flex space-x-4 mt-4"></div>

            <!-- ê·¸ë£¹í•‘ ê²Œì„ ì˜ì—­ -->
            <div id="game-container" class="hidden space-y-4">
                <p id="game-instructions" class="text-lg font-semibold text-center text-blue-600"></p>
                <!-- ê²Œì„ ì¹´ë“œ (ì¸ë¬¼) -->
                <div id="game-cards-container" class="flex flex-wrap justify-center gap-2 p-3 bg-gray-100 rounded-lg">
                    <!-- ì¸ë¬¼ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
                <!-- ê²Œì„ ë²„í‚· (ê·¸ë£¹) -->
                <div id="game-buckets-container" class="grid grid-cols-3 gap-3">
                    <!-- ê·¸ë£¹ ë²„í‚·ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
                <!-- ê²Œì„ ë„¤ë¹„ê²Œì´ì…˜ -->
                <div id="game-nav-container" class="flex justify-between items-center mt-4">
                    <button id="game-prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">ì´ì „ ë‹¨ê³„</button>
                    <span id="game-stage-indicator" class="text-sm font-medium">1 / 5</span>
                    <button id="game-next-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">ë‹¤ìŒ ë‹¨ê³„</button>
                    <button id="game-submit-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">ì œì¶œ</button>
                </div>
            </div>

            <button id="next-question-btn" class="w-full mt-8 bg-gray-300 text-gray-500 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 cursor-not-allowed" disabled>
                ë‹¤ìŒ
            </button>
        </div>

        <!-- 3. ê²°ê³¼ í™”ë©´ -->
        <div id="results-screen" class="screen text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-4">í€´ì¦ˆ ì™„ë£Œ!</h1>
            <div class="bg-blue-50 p-6 rounded-lg shadow-inner mb-6">
                <h2 class="text-2xl font-semibold mb-2">ë‹¹ì‹ ì˜ ì ìˆ˜</h2>
                <p class="text-5xl font-bold text-blue-600"><span id="score">0</span> / <span id="total-score">11</span></p>
            </div>
            
            <div class="text-left mb-6">
                <h3 class="text-2xl font-semibold mb-4">ìƒì„¸ í”¼ë“œë°±</h3>
                <div id="feedback-container" class="space-y-4 max-h-80 overflow-y-auto p-4 bg-gray-50 rounded-lg border">
                    <!-- í”¼ë“œë°±ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <button id="save-results-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 shadow-md">
                ê²°ê³¼ ì €ì¥í•˜ê¸°
            </button>
            <button id="restart-quiz-btn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">
                ë‹¤ì‹œ í’€ê¸°
            </button>
        </div>

    </div>

    <script>
        // --- 1. í€´ì¦ˆ ë°ì´í„° ---
        const questions = [
            // ì—°ìŠµ 1 ì–´íœ˜ (5ê°œ)
            {
                vocab: 'ëŒ€í‘œì ì´ë‹¤',
                type: 'mc',
                question: 'ë¶ˆê³ ê¸°ëŠ” í•œêµ­ì„ ________-ëŠ” ìŒì‹ì…ë‹ˆë‹¤.',
                options: ['ëŒ€í‘œì ì¸', 'ê³µí†µì ì¸', 'ì°¨ì´ê°€ ìˆëŠ”', 'ì˜í–¥ì„ ë°›ì€'],
                answer: 'ëŒ€í‘œì ì¸'
            },
            {
                vocab: 'ê³µí†µì ì´ ìˆë‹¤',
                type: 'ox',
                question: 'ë¬¸ì¥ì´ ë°”ë¦…ë‹ˆê¹Œ?: "í•œêµ­ê³¼ ì„œì–‘ì˜ ê²°í˜¼ì‹ì€ ì•„ë¬´ëŸ° ê³µí†µì ì´ ì—†ë‹¤."',
                hint: 'ë‘ ë¬¸í™” ëª¨ë‘ \'ê²°í˜¼\'ì´ë¼ëŠ” ì¤‘ìš”í•œ ì˜ì‹ì…ë‹ˆë‹¤.',
                answer: 'x'
            },
            {
                vocab: 'ì°¨ì´ê°€ ìˆë‹¤',
                type: 'dialogue',
                question: 'A: ë‘ ë‚˜ë¼ì˜ ë¬¸í™”ëŠ” ë¹„ìŠ·í•œê°€ìš”?\nB: ì•„ë‹ˆìš”, ì—¬ëŸ¬ ë©´ì—ì„œ ________.',
                options: ['ì°¨ì´ê°€ ìˆì–´ìš”', 'ê³µí†µì ì´ ìˆì–´ìš”', 'ì˜í–¥ì„ ë°›ì•˜ì–´ìš”', 'ì „í†µì„ ì§€ì¼°ì–´ìš”'],
                answer: 'ì°¨ì´ê°€ ìˆì–´ìš”'
            },
            {
                vocab: 'ì „í†µì„ ì§€í‚¤ë‹¤',
                type: 'mc',
                question: 'ìš”ì¦˜ì—ë„ í•œë³µì„ ì…ê³  ê²°í˜¼í•˜ëŠ” ê²ƒì€ ________-ëŠ” ê²ƒì…ë‹ˆë‹¤.',
                options: ['ì „í†µì„ ì§€í‚¤ëŠ”', 'ì˜í–¥ì„ ë°›ëŠ”', 'ì°¨ì´ê°€ ìˆëŠ”', 'ëŒ€í‘œì ì¸'],
                answer: 'ì „í†µì„ ì§€í‚¤ëŠ”'
            },
            {
                vocab: 'ì˜í–¥ì„ ë°›ë‹¤',
                type: 'ox',
                question: 'ë¬¸ì¥ì´ ë°”ë¦…ë‹ˆê¹Œ?: "í•œêµ­ì˜ ê²°í˜¼ ë¬¸í™”ëŠ” ì„œì–‘ ë¬¸í™”ì— ì „í˜€ ì˜í–¥ì„ ë°›ì§€ ì•Šì•˜ë‹¤."',
                answer: 'x'
            },
            // ì—°ìŠµ 2 ì–´íœ˜ (5ê°œ)
            {
                vocab: 'ë…íŠ¹í•˜ë‹¤',
                type: 'dialogue',
                question: 'A: ì´ í‹°ì…”ì¸  ì–´ë•Œìš”?\nB: ë¬´ëŠ¬ê°€ ì•„ì£¼ ________-ë„¤ìš”. ë‹¤ë¥¸ ë°ì„œ ë³¸ ì ì´ ì—†ì–´ìš”.',
                options: ['ë…íŠ¹í•˜', 'í‰ë²”í•˜', 'ë‹¨ìˆœí•˜', 'í”í•˜']
                ,
                answer: 'ë…íŠ¹í•˜'
            },
            {
                vocab: 'í¥ë¯¸ë¡­ë‹¤',
                type: 'mc',
                question: 'ì²˜ìŒ ë“£ëŠ” ì´ì•¼ê¸°ê°€ ì•„ì£¼ ________.',
                options: ['í¥ë¯¸ë¡œì› ë‹¤', 'ë‹¨ìˆœí–ˆë‹¤', 'í‰ë²”í–ˆë‹¤', 'í”í–ˆë‹¤'],
                answer: 'í¥ë¯¸ë¡œì› ë‹¤'
            },
            {
                vocab: 'ë‹¨ìˆœí•˜ë‹¤',
                type: 'ox',
                question: 'ë¬¸ì¥ì´ ë°”ë¦…ë‹ˆê¹Œ?: "ê·¸ë¦¼ì´ ì•„ì£¼ ë³µì¡í•˜ê³  ë¬´ëŠ¬ê°€ ë§ì•„ì„œ ë‹¨ìˆœí•˜ë‹¤."',
                answer: 'x'
            },
            {
                vocab: 'í‰ë²”í•˜ë‹¤',
                type: 'mc',
                question: 'A: ì§€ì—° ì”¨ ìƒì¼ ì„ ë¬¼ë¡œ ë­ê°€ ì¢‹ì„ê¹Œìš”?\nB: ________-ã„´ ëª©ë„ë¦¬ë³´ë‹¤ëŠ” ì¢€ íŠ¹ë³„í•œ ê²Œ ì¢‹ì§€ ì•Šì„ê¹Œìš”?',
                options: ['í‰ë²”í•˜', 'ë…íŠ¹í•˜', 'í¥ë¯¸ë¡­', 'ë‹¨ìˆœí•˜'],
                answer: 'í‰ë²”í•˜'
            },
            {
                vocab: 'í”í•˜ë‹¤',
                type: 'ox',
                question: 'ë¬¸ì¥ì´ ë°”ë¦…ë‹ˆê¹Œ?: "ì´ëŸ° ë””ìì¸ì€ ì–´ë””ì„œë‚˜ ë³¼ ìˆ˜ ìˆì–´ì„œ ì•„ì£¼ í”í•˜ë‹¤."',
                answer: 'o'
            },
            // ì—°ìŠµ 3 - ê·¸ë£¹í•‘ ê²Œì„ (1ê°œ)
            {
                vocab: 'ê·¸ë£¹í•‘ ê²Œì„',
                type: 'game',
                question: 'ì—°ìŠµ 3: ì¸ë¬¼ ê·¸ë£¹í•‘ ê²Œì„',
                characters: ['ë£¨ì¦ˆ', 'ë§ˆí¬', 'ì˜ìˆ˜', 'ìœ ë¦¬', 'ë§ˆë¦¬', 'ìœ íƒ€'],
                stages: [
                    {
                        criterion: 'ë‚˜ì´ë³„',
                        buckets: ['ì–´ë¦°ì´', 'ì²­ì†Œë…„', 'ì„±ì¸'],
                        answer: { 'ì–´ë¦°ì´': ['ë£¨ì¦ˆ', 'ìœ ë¦¬', 'ìœ íƒ€'], 'ì²­ì†Œë…„': ['ì˜ìˆ˜', 'ë§ˆë¦¬'], 'ì„±ì¸': ['ë§ˆí¬'] }
                    },
                    {
                        criterion: 'ë‚˜ë¼ë³„',
                        buckets: ['í•œêµ­', 'ë¯¸êµ­', 'ì¼ë³¸'],
                        answer: { 'í•œêµ­': ['ì˜ìˆ˜', 'ìœ ë¦¬'], 'ë¯¸êµ­': ['ë£¨ì¦ˆ', 'ë§ˆí¬'], 'ì¼ë³¸': ['ë§ˆë¦¬', 'ìœ íƒ€'] }
                    },
                    {
                        criterion: 'ì§ì—…ë³„',
                        buckets: ['í•™ìƒ', 'ìš”ë¦¬ì‚¬', 'ì‹ ë¬¸ ê¸°ì'],
                        answer: { 'í•™ìƒ': ['ë£¨ì¦ˆ', 'ì˜ìˆ˜', 'ë§ˆë¦¬', 'ìœ íƒ€'], 'ìš”ë¦¬ì‚¬': ['ìœ ë¦¬'], 'ì‹ ë¬¸ ê¸°ì': ['ë§ˆí¬'] }
                    },
                    {
                        criterion: 'ê´€ì‹¬ ë¶„ì•¼ë³„',
                        buckets: ['ë…¸ë˜', 'ì‚¬ì§„', 'ê°„ì‹'],
                        answer: { 'ë…¸ë˜': ['ë£¨ì¦ˆ', 'ë§ˆë¦¬'], 'ì‚¬ì§„': ['ë§ˆí¬', 'ìœ íƒ€'], 'ê°„ì‹': ['ì˜ìˆ˜', 'ìœ ë¦¬'] }
                    },
                    {
                        criterion: 'í™œë™ ì§€ì—­ë³„',
                        buckets: ['ê³ í–¥ ë§ˆì„', 'ì „êµ­', 'ì „ ì„¸ê³„'],
                        answer: { 'ê³ í–¥ ë§ˆì„': ['ë£¨ì¦ˆ', 'ìœ ë¦¬'], 'ì „êµ­': ['ì˜ìˆ˜', 'ë§ˆë¦¬'], 'ì „ ì„¸ê³„': ['ë§ˆí¬', 'ìœ íƒ€'] }
                    }
                ],
                answer: 'game_correct' // ì •ë‹µìœ¼ë¡œ ê°„ì£¼ë  ê°’
            }
        ];

        // --- 2. ì „ì—­ ë³€ìˆ˜ ---
        const mainScreen = document.getElementById('main-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const screens = [mainScreen, quizScreen, resultsScreen];

        const startQuizBtn = document.getElementById('start-quiz-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        // ... (ê¸°ì¡´ ë³€ìˆ˜ë“¤) ...
        const historyModal = document.getElementById('history-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const closeModalBtnBottom = document.getElementById('close-modal-btn-bottom');
        const saveResultsBtn = document.getElementById('save-results-btn');
        const showHistoryBtn = document.getElementById('show-history-btn');
        const historyContainer = document.getElementById('history-container');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        const questionNumberEl = document.getElementById('question-number');
        const totalQuestionsEl = document.getElementById('total-questions');
        const hintBtn = document.getElementById('hint-btn');
        const hintTextEl = document.getElementById('hint-text');
        const progressBar = document.getElementById('progress-bar');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const oxOptionsContainer = document.getElementById('ox-options-container');

        // ê²Œì„ìš© ë³€ìˆ˜
        const gameContainer = document.getElementById('game-container');
        const gameInstructions = document.getElementById('game-instructions');
        const gameCardsContainer = document.getElementById('game-cards-container');
        const gameBucketsContainer = document.getElementById('game-buckets-container');
        const gameNavContainer = document.getElementById('game-nav-container');
        const gamePrevBtn = document.getElementById('game-prev-btn');
        const gameNextBtn = document.getElementById('game-next-btn');
        const gameSubmitBtn = document.getElementById('game-submit-btn');
        const gameStageIndicator = document.getElementById('game-stage-indicator');

        const scoreEl = document.getElementById('score');
        const totalScoreEl = document.getElementById('total-score');
        const feedbackContainer = document.getElementById('feedback-container');

        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let feedbackDetails = [];

        // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
        let currentGameStage = 0;
        let gameAssignments = {}; // { 0: {'ë²„í‚·1': ['ì¸ë¬¼1'], ...}, 1: {...} }
        let selectedCard = null;
        let totalGameStages = 5;

        // --- 3. í™”ë©´ ì „í™˜ í•¨ìˆ˜ ---
        function showScreen(screenId) {
            screens.forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.add('active');
                } else {
                    screen.classList.remove('active');
                }
            });
        }

        // --- 4. í€´ì¦ˆ ë¡œì§ í•¨ìˆ˜ ---

        function startQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            feedbackDetails = [];
            totalQuestionsEl.textContent = questions.length;
            totalScoreEl.textContent = questions.length;

            // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            currentGameStage = 0;
            gameAssignments = {};
            selectedCard = null;

            // 'ê²°ê³¼ ì €ì¥í•˜ê¸°' ë²„íŠ¼ ì´ˆê¸°í™”
            saveResultsBtn.textContent = 'ê²°ê³¼ ì €ì¥í•˜ê¸°';
            saveResultsBtn.disabled = false;
            saveResultsBtn.classList.replace('bg-gray-400', 'bg-green-500');

            showScreen('quiz-screen');
            loadQuestion();
        }

        function loadQuestion() {
            // ëª¨ë“  ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            optionsContainer.innerHTML = '';
            optionsContainer.style.display = 'none';
            oxOptionsContainer.innerHTML = '';
            oxOptionsContainer.style.display = 'none';
            gameContainer.style.display = 'none';
            hintBtn.style.display = 'block'; // íŒíŠ¸ ë²„íŠ¼ í‘œì‹œ
            hintTextEl.classList.add('hidden');
            
            disableNextButton();

            if (currentQuestionIndex >= questions.length) {
                showResults();
                return;
            }

            const question = questions[currentQuestionIndex];
            
            questionNumberEl.textContent = currentQuestionIndex + 1;
            questionTextEl.innerHTML = question.question.replace(/\n/g, '<br>');
            
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;

            // íŒíŠ¸ ì„¤ì •
            let hint = question.vocab;
            if (question.hint) hint = question.hint;
            hintTextEl.textContent = hint;

            if (question.type === 'mc' || question.type === 'dialogue') {
                optionsContainer.style.display = 'block';
                const shuffledOptions = [...question.options].sort(() => Math.random() - 0.5);
                shuffledOptions.forEach(option => {
                    const optionId = `q${currentQuestionIndex}_${option.replace(/\s+/g, '_')}`;
                    optionsContainer.innerHTML += `
                        <div>
                            <input type="radio" name="option" id="${optionId}" value="${option}" class="option-input hidden">
                            <label for="${optionId}" class="option-label block w-full text-left p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                ${option}
                            </label>
                        </div>`;
                });
            } else if (question.type === 'ox') {
                oxOptionsContainer.style.display = 'flex';
                const options = ['o', 'x'];
                options.forEach(option => {
                    const optionId = `q${currentQuestionIndex}_${option}`;
                    const optionText = option === 'o' ? 'O (ë§ë‹¤)' : 'X (í‹€ë¦¬ë‹¤)';
                    oxOptionsContainer.innerHTML += `
                        <div class="flex-1">
                            <input type="radio" name="option" id="${optionId}" value="${option}" class="option-input hidden">
                            <label for="${optionId}" class="option-label block w-full text-center p-4 border-2 ${option === 'o' ? 'border-blue-400' : 'border-red-400'} rounded-lg cursor-pointer hover:bg-gray-50 text-xl font-bold">
                                ${optionText}
                            </label>
                        </div>`;
                });
            } else if (question.type === 'game') {
                gameContainer.style.display = 'block';
                hintBtn.style.display = 'none'; // ê²Œì„ ì¤‘ì—ëŠ” íŒíŠ¸ ìˆ¨ê¸°ê¸°
                loadGame(question);
            }

            // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê²Œì„ì´ ì•„ë‹ ë•Œë§Œ)
            if (question.type !== 'game') {
                document.querySelectorAll('input[name="option"]').forEach(input => {
                    input.addEventListener('change', () => {
                        userAnswers[currentQuestionIndex] = input.value;
                        enableNextButton();
                    });
                });
            }
        }

        function enableNextButton() {
            nextQuestionBtn.disabled = false;
            nextQuestionBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
            nextQuestionBtn.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
            if (currentQuestionIndex === questions.length - 1) {
                nextQuestionBtn.textContent = 'ê²°ê³¼ ë³´ê¸°';
            } else {
                nextQuestionBtn.textContent = 'ë‹¤ìŒ';
            }
        }

        function disableNextButton() {
            nextQuestionBtn.disabled = true;
            nextQuestionBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
            nextQuestionBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        // --- 5. ê²Œì„ ë¡œì§ í•¨ìˆ˜ ---
        function loadGame(question) {
            totalGameStages = question.stages.length;
            // gameAssignments ì´ˆê¸°í™” (ê° ìŠ¤í…Œì´ì§€ë³„ë¡œ)
            if (Object.keys(gameAssignments).length === 0) {
                question.stages.forEach((stage, index) => {
                    gameAssignments[index] = {};
                    stage.buckets.forEach(bucket => {
                        gameAssignments[index][bucket] = [];
                    });
                });
            }
            loadGameStage(currentGameStage);
        }

        function loadGameStage(stageIndex) {
            const question = questions[currentQuestionIndex];
            const stage = question.stages[stageIndex];
            const characters = question.characters;
            const currentAssignments = gameAssignments[stageIndex];

            gameInstructions.textContent = `ë‹¨ê³„ ${stageIndex + 1}/${totalGameStages}: ì¸ë¬¼ë“¤ì„ '${stage.criterion}'(ìœ¼)ë¡œ ê·¸ë£¹í•‘í•˜ì„¸ìš”.`;
            gameStageIndicator.textContent = `${stageIndex + 1} / ${totalGameStages}`;

            // ì¸ë¬¼ ì¹´ë“œ ë Œë”ë§
            gameCardsContainer.innerHTML = '';
            characters.forEach(char => {
                // ì´ ì¸ë¬¼ì´ ì´ ìŠ¤í…Œì´ì§€ì˜ ë²„í‚·ì— ì´ë¯¸ ë°°ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
                const isAssigned = Object.values(currentAssignments).some(arr => arr.includes(char));
                
                const cardEl = document.createElement('div');
                cardEl.textContent = char;
                cardEl.className = 'game-card p-3 border rounded-lg shadow-sm cursor-pointer font-medium';
                if (isAssigned) {
                    cardEl.classList.add('assigned');
                } else if (selectedCard === char) {
                    cardEl.classList.add('selected');
                }
                
                cardEl.addEventListener('click', () => {
                    if (isAssigned) return; // ì´ë¯¸ ë°°ì •ëœ ì¹´ë“œëŠ” í´ë¦­ X
                    handleCardClick(char, cardEl);
                });
                gameCardsContainer.appendChild(cardEl);
            });

            // ë²„í‚· ë Œë”ë§
            gameBucketsContainer.innerHTML = '';
            stage.buckets.forEach(bucketName => {
                const bucketEl = document.createElement('div');
                bucketEl.className = 'game-bucket w-full p-3 border-2 border-dashed border-gray-400 rounded-lg';
                
                let bucketHTML = `<h4 class="font-semibold text-center pb-2 border-b">${bucketName}</h4><div class="mt-2 space-y-1">`;
                currentAssignments[bucketName].forEach(char => {
                    bucketHTML += `<div class="game-bucket-card p-1.5 bg-blue-100 text-blue-800 rounded text-sm" data-char="${char}" data-bucket="${bucketName}">
                                    ${char} (í´ë¦­í•˜ì—¬ ë¹¼ê¸°)
                                   </div>`;
                });
                bucketHTML += `</div>`;
                bucketEl.innerHTML = bucketHTML;

                // ë²„í‚· í´ë¦­ (ì¸ë¬¼ ë°°ì •)
                bucketEl.addEventListener('click', () => {
                    handleBucketClick(bucketName, stageIndex);
                });

                // ë²„í‚· ì•ˆì˜ ì¸ë¬¼ í´ë¦­ (ì¸ë¬¼ ë¹¼ê¸°)
                bucketEl.querySelectorAll('.game-bucket-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        e.stopPropagation(); // ë²„í‚· í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                        handleRemoveCardFromBucket(card.dataset.char, card.dataset.bucket, stageIndex);
                    });
                });

                gameBucketsContainer.appendChild(bucketEl);
            });

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            gamePrevBtn.style.display = stageIndex === 0 ? 'none' : 'block';
            gameNextBtn.style.display = stageIndex === totalGameStages - 1 ? 'none' : 'block';
            gameSubmitBtn.style.display = stageIndex === totalGameStages - 1 ? 'block' : 'none';
        }

        function handleCardClick(char, cardEl) {
            // ì´ë¯¸ ì„ íƒëœ ì¹´ë“œë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
            if (selectedCard === char) {
                selectedCard = null;
                cardEl.classList.remove('selected');
            } else {
                selectedCard = char;
                // ëª¨ë“  ì¹´ë“œì—ì„œ 'selected' ì œê±° í›„ í˜„ì¬ ì¹´ë“œì— ì¶”ê°€
                document.querySelectorAll('.game-card').forEach(c => c.classList.remove('selected'));
                cardEl.classList.add('selected');
            }
        }

        function handleBucketClick(bucketName, stageIndex) {
            if (!selectedCard) return; // ì„ íƒëœ ì¹´ë“œê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ

            // ì´ ìŠ¤í…Œì´ì§€ì˜ í• ë‹¹ì •ë³´ì— ì¹´ë“œ ì¶”ê°€
            gameAssignments[stageIndex][bucketName].push(selectedCard);
            selectedCard = null; // ì¹´ë“œ ì„ íƒ í•´ì œ

            // í˜„ì¬ ìŠ¤í…Œì´ì§€ ìƒˆë¡œê³ ì¹¨
            loadGameStage(stageIndex);
        }
        
        function handleRemoveCardFromBucket(char, bucketName, stageIndex) {
            const bucketArray = gameAssignments[stageIndex][bucketName];
            const index = bucketArray.indexOf(char);
            if (index > -1) {
                bucketArray.splice(index, 1);
            }
            // í˜„ì¬ ìŠ¤í…Œì´ì§€ ìƒˆë¡œê³ ì¹¨
            loadGameStage(stageIndex);
        }

        // ê²Œì„ ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸
        gamePrevBtn.addEventListener('click', () => {
            if (currentGameStage > 0) {
                currentGameStage--;
                loadGameStage(currentGameStage);
            }
        });

        gameNextBtn.addEventListener('click', () => {
            if (currentGameStage < totalGameStages - 1) {
                currentGameStage++;
                loadGameStage(currentGameStage);
            }
        });

        gameSubmitBtn.addEventListener('click', () => {
            // ê²Œì„ ì •ë‹µ ì±„ì 
            const isCorrect = checkGameAnswer();
            userAnswers[currentQuestionIndex] = isCorrect ? 'game_correct' : 'game_incorrect';
            enableNextButton(); // 'ê²°ê³¼ ë³´ê¸°' ë²„íŠ¼ í™œì„±í™”
            
            // ê²Œì„ UI ë¹„í™œì„±í™”
            gameContainer.querySelectorAll('button, .game-card, .game-bucket-card').forEach(el => el.disabled = true);
            gameContainer.style.opacity = 0.7;
            gameInstructions.textContent = "ê²Œì„ ì™„ë£Œ! 'ê²°ê³¼ ë³´ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
        });

        function checkGameAnswer() {
            const question = questions[currentQuestionIndex];
            for (let i = 0; i < totalGameStages; i++) {
                const stage = question.stages[i];
                const userAnswer = gameAssignments[i];
                const correctAnswer = stage.answer;

                // ì •ë‹µê³¼ ì‚¬ìš©ìì˜ ë‹µì´ ê°™ì€ì§€ ë¹„êµ (ë°°ì—´ ì •ë ¬ í›„ ë¹„êµ)
                const userKeys = Object.keys(userAnswer);
                const correctKeys = Object.keys(correctAnswer);

                if (userKeys.length !== correctKeys.length) return false;

                for (const key of correctKeys) {
                    if (!userAnswer[key] || 
                        userAnswer[key].slice().sort().join(',') !== correctAnswer[key].slice().sort().join(',')) {
                        return false; // í•˜ë‚˜ë¼ë„ í‹€ë¦¬ë©´ false
                    }
                }
            }
            return true; // ëª¨ë“  ìŠ¤í…Œì´ì§€ê°€ ë§ìœ¼ë©´ true
        }


        // --- 6. ê²°ê³¼ ë° ê¸°ë¡ í•¨ìˆ˜ ---
        function showResults() {
            score = 0;
            feedbackDetails = [];
            feedbackContainer.innerHTML = '';

            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = q.answer;
                const isCorrect = userAnswer === correctAnswer;

                if (isCorrect) {
                    score++;
                }

                const feedback = {
                    question: q.question,
                    vocab: q.vocab,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    isCorrect: isCorrect,
                    type: q.type
                };
                feedbackDetails.push(feedback);

                const feedbackElement = document.createElement('div');
                feedbackElement.className = `p-4 rounded-lg ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}`;
                
                let answerText, userAnswerText;

                if (q.type === 'ox') {
                    answerText = correctAnswer === 'o' ? 'O (ë§ë‹¤)' : 'X (í‹€ë¦¬ë‹¤)';
                    userAnswerText = userAnswer === 'o' ? 'O (ë§ë‹¤)' : 'X (í‹€ë¦¬ë‹¤)';
                } else if (q.type === 'game') {
                    answerText = "ê²Œì„ ì„±ê³µ";
                    userAnswerText = isCorrect ? "ê²Œì„ ì„±ê³µ" : "ê²Œì„ ì‹¤íŒ¨";
                } else {
                    answerText = correctAnswer;
                    userAnswerText = userAnswer;
                }

                feedbackElement.innerHTML = `
                    <p class="font-semibold text-gray-800">${index + 1}. [${q.vocab}] ${q.question.replace(/\n/g, '<br>')}</p>
                    <p class="mt-2 text-sm"><strong>ì •ë‹µ:</strong> ${answerText || 'N/A'}</p>
                    <p class="text-sm"><strong>ì„ íƒ:</strong> ${userAnswerText || 'N/A'} ${isCorrect ? 'ğŸ‘' : 'ğŸ‘'}</p>
                `;
                feedbackContainer.appendChild(feedbackElement);
            });

            scoreEl.textContent = score;
            showScreen('results-screen');
        }

        function restartQuiz() {
            showScreen('main-screen');
        }

        function saveResults() {
            const history = JSON.parse(localStorage.getItem('quizHistory_v3') || '[]');
            const resultData = {
                date: new Date().toLocaleString('ko-KR'),
                score: score,
                total: questions.length,
                feedback: feedbackDetails
            };
            history.push(resultData);
            localStorage.setItem('quizHistory_v3', JSON.stringify(history));
            
            saveResultsBtn.textContent = 'ì €ì¥ ì™„ë£Œ!';
            saveResultsBtn.disabled = true;
            saveResultsBtn.classList.replace('bg-green-500', 'bg-gray-400');
            
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('quizHistory_v3') || '[]');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                historyContainer.classList.add('hidden');
                return;
            }

            historyContainer.classList.remove('hidden');
            
            history.reverse().forEach((record, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'p-3 bg-white border rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-50';
                historyItem.innerHTML = `
                    <span>
                        <span class="font-semibold">${record.date}</span>
                        <span class="ml-2 text-blue-600 font-bold">${record.score} / ${record.total} ì </span>
                    </span>
                    <span class="text-sm text-gray-500">ìƒì„¸ë³´ê¸° &gt;</span>
                `;
                historyItem.addEventListener('click', () => showHistoryDetail(record));
                historyList.appendChild(historyItem);
            });
        }

        function showHistoryDetail(record) {
            modalContent.innerHTML = '';
            
            modalContent.innerHTML += `
                <h4 class="text-lg font-bold">${record.date}</h4>
                <p class="text-2xl font-bold text-blue-600 mb-4">ì´ì : ${record.score} / ${record.total}</p>
            `;

            record.feedback.forEach((fb, index) => {
                let answerText, userAnswerText;

                if (fb.type === 'ox') {
                    answerText = fb.correctAnswer === 'o' ? 'O (ë§ë‹¤)' : 'X (í‹€ë¦¬ë‹¤)';
                    userAnswerText = fb.userAnswer === 'o' ? 'O (ë§ë‹¤)' : 'X (í‹€ë¦¬ë‹¤)';
                } else if (fb.type === 'game') {
                    answerText = "ê²Œì„ ì„±ê³µ";
                    userAnswerText = fb.isCorrect ? "ê²Œì„ ì„±ê³µ" : "ê²Œì„ ì‹¤íŒ¨";
                } else {
                    answerText = fb.correctAnswer;
                    userAnswerText = fb.userAnswer;
                }

                modalContent.innerHTML += `
                    <div class="p-4 rounded-lg mb-3 ${fb.isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                        <p class="font-semibold text-gray-800">${index + 1}. [${fb.vocab}] ${fb.question.replace(/\n/g, '<br>')}</p>
                        <p class="mt-2 text-sm"><strong>ì •ë‹µ:</strong> ${answerText || 'N/A'}</p>
                        <p class="text-sm"><strong>ì„ íƒ:</strong> ${userAnswerText || 'N/A'} ${fb.isCorrect ? 'ğŸ‘' : 'ğŸ‘'}</p>
                    </div>
                `;
            });

            historyModal.classList.remove('hidden');
        }

        function closeModal() {
            historyModal.classList.add('hidden');
        }

        function clearHistory() {
            if (window.confirm('ì •ë§ë¡œ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('quizHistory_v3');
                loadHistory();
            }
        }

        // --- 7. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        startQuizBtn.addEventListener('click', startQuiz);
        nextQuestionBtn.addEventListener('click', nextQuestion);
        restartQuizBtn.addEventListener('click', restartQuiz);
        saveResultsBtn.addEventListener('click', saveResults);
        
        showHistoryBtn.addEventListener('click', () => {
            loadHistory();
            historyContainer.classList.toggle('hidden');
        });
        
        clearHistoryBtn.addEventListener('click', clearHistory);
        
        closeModalBtn.addEventListener('click', closeModal);
        closeModalBtnBottom.addEventListener('click', closeModal);

        hintBtn.addEventListener('click', () => {
            hintTextEl.classList.remove('hidden');
            hintBtn.style.display = 'none';
        });

        // ì´ˆê¸° í™”ë©´ ì„¤ì •
        showScreen('main-screen');
    </script>
</body>
</html>
