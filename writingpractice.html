<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국어 쓰기 학습 도우미</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Header: Title and Language Selector -->
        <header class="flex justify-between items-center mb-6 bg-white p-4 rounded-lg shadow-md">
            <h1 id="app-title" class="text-2xl md:text-3xl font-bold text-blue-600"></h1>
            <div class="flex items-center space-x-2">
                <i class="fas fa-globe text-gray-500"></i>
                <select id="language-selector" class="p-2 border rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="ko">한국어</option>
                    <option value="en">English</option>
                    <option value="vi">Tiếng Việt</option>
                    <option value="ja">日本語</option>
                    <option value="zh">中文</option>
                </select>
            </div>
        </header>

        <main id="main-content" class="fade-in bg-white p-6 rounded-lg shadow-md">
            <!-- Writing Topic -->
            <div class="mb-8 border-b pb-6">
                <h2 id="writing-topic-title" class="text-xl font-bold mb-4"></h2>
                <p id="writing-topic-desc" class="text-gray-600 leading-relaxed"></p>
            </div>

            <!-- All Steps in One View -->
            <div id="writing-container" class="space-y-8">
                <!-- Steps will be dynamically injected here -->
            </div>
            
            <!-- Download Button Container -->
            <div id="download-container" class="text-right mt-8 border-t pt-6"></div>
        </main>

        <!-- Modal for Grammar Examples -->
        <div id="grammar-modal" class="modal-overlay hidden">
            <div class="modal-content fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modal-title" class="text-xl font-bold"></h3>
                    <button id="close-modal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                </div>
                <div id="modal-body" class="space-y-3"></div>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const app = {
            // STATE
            state: {
                currentLanguage: 'ko',
                writings: {}
            },

            // TRANSLATIONS
            translations: {
                ko: {
                    appTitle: "쓰기 학습 도우미",
                    writingTopicTitle: "오늘의 쓰기 주제",
                    writingTopicDesc: "한 실험에서 남성과 여성의 주차 시간을 확인했습니다. 남자는 43초, 여자는 3분 1초가 걸렸습니다. 이 결과를 보고 여러분의 생각을 글로 써 보세요.",
                    save: "저장하기",
                    saved: "저장됨!",
                    practiceGrammar: "추천 문법",
                    practiceParagraph: "단락 쓰기",
                    step1Title: "1단계: 실험 결과 설명하기",
                    step1Desc: "실험 결과를 객관적으로 설명하는 방법을 배웁니다.",
                    step2Title: "2단계: 결과 분석하기",
                    step2Desc: "결과가 왜 그렇게 나왔는지 이유를 추측하고 분석하는 방법을 배웁니다.",
                    step3Title: "3단계: 나의 생각 쓰기",
                    step3Desc: "분석한 내용을 바탕으로 자신의 생각과 주장을 논리적으로 쓰는 방법을 배웁니다.",
                    grammarExamples: "문법 예문",
                    close: "닫기",
                    paragraphPracticePlaceholder: (part) => `${part} 부분에 들어갈 글을 여기에 써 보세요...`,
                    downloadAsTxt: "텍스트 파일로 저장하기"
                },
                en: {
                    appTitle: "Writing Helper",
                    writingTopicTitle: "Today's Writing Topic",
                    writingTopicDesc: "An experiment compared the parking times of a man and a woman. The man took 43 seconds, and the woman took 3 minutes and 1 second. Write an essay presenting your opinion based on this result.",
                    save: "Save",
                    saved: "Saved!",
                    practiceGrammar: "Recommended Grammar",
                    practiceParagraph: "Paragraph Practice",
                    step1Title: "Step 1: Describing the Results",
                    step1Desc: "Learn how to objectively describe the experiment's results.",
                    step2Title: "Step 2: Analyzing the Results",
                    step2Desc: "Learn how to infer and analyze the reasons behind the results.",
                    step3Title: "Step 3: Stating Your Opinion",
                    step3Desc: "Learn how to logically write your own thoughts and arguments based on your analysis.",
                    grammarExamples: "Grammar Examples",
                    close: "Close",
                    paragraphPracticePlaceholder: (part) => `Write your text for the '${part}' section here...`,
                    downloadAsTxt: "Download as .txt file"
                },
                vi: {
                    appTitle: "Hỗ trợ Viết",
                    writingTopicTitle: "Chủ đề Viết hôm nay",
                    writingTopicDesc: "Một thí nghiệm đã so sánh thời gian đỗ xe của một người đàn ông và một người phụ nữ. Người đàn ông mất 43 giây và người phụ nữ mất 3 phút 1 giây. Dựa trên kết quả này, hãy viết một bài văn trình bày ý kiến của bạn.",
                    save: "Lưu",
                    saved: "Đã lưu!",
                    practiceGrammar: "Ngữ pháp đề xuất",
                    practiceParagraph: "Luyện tập Đoạn văn",
                    step1Title: "Bước 1: Mô tả kết quả thí nghiệm",
                    step1Desc: "Học cách mô tả kết quả thí nghiệm một cách khách quan.",
                    step2Title: "Bước 2: Phân tích kết quả",
                    step2Desc: "Học cách suy luận và phân tích lý do đằng sau kết quả.",
                    step3Title: "Bước 3: Trình bày ý kiến của bạn",
                    step3Desc: "Học cách viết những suy nghĩ và lập luận của riêng bạn một cách logic dựa trên phân tích của bạn.",
                    grammarExamples: "Ví dụ Ngữ pháp",
                    close: "Đóng",
                    paragraphPracticePlaceholder: (part) => `Viết nội dung cho phần '${part}' tại đây...`,
                    downloadAsTxt: "Tải xuống dưới dạng tệp .txt"
                },
                ja: {
                    appTitle: "作文ヘルパー",
                    writingTopicTitle: "今日の作文テーマ",
                    writingTopicDesc: "ある実験で、男性と女性の駐車時間を比較しました。男性は43秒、女性は3分1秒かかりました。この結果に基づいて、自分の意見を提示する文章を書きましょう。",
                    save: "保存",
                    saved: "保存されました！",
                    practiceGrammar: "おすすめの文法",
                    practiceParagraph: "段落作成",
                    step1Title: "ステップ1：実験結果を説明する",
                    step1Desc: "実験の結果を客観的に説明する方法を学びます。",
                    step2Title: "ステップ2：結果を分析する",
                    step2Desc: "なぜそのような結果になったのか、理由を推測し分析する方法を学びます。",
                    step3Title: "ステップ3：自分の考えを書く",
                    step3Desc: "分析した内容に基づいて、自分の考えや主張を論理的に書く方法を学びます。",
                    grammarExamples: "文法例文",
                    close: "閉じる",
                    paragraphPracticePlaceholder: (part) => `「${part}」部分の文章をここに作成してください...`,
                    downloadAsTxt: "テキストファイルで保存"
                },
                zh: {
                    appTitle: "写作助手",
                    writingTopicTitle: "今日写作主题",
                    writingTopicDesc: "一项实验比较了男女的停车时间。男性用时43秒，女性用时3分1秒。请根据此结果写一篇提出自己意见的文章。",
                    save: "保存",
                    saved: "已保存！",
                    practiceGrammar: "推荐语法",
                    practiceParagraph: "段落写作",
                    step1Title: "第一步：描述实验结果",
                    step1Desc: "学习如何客观地描述实验结果。",
                    step2Title: "第二步：分析结果",
                    step2Desc: "学习如何推断和分析结果背后的原因。",
                    step3Title: "第三步：阐述我的观点",
                    step3Desc: "学习如何根据你的分析，有逻辑地写出自己的想法和论点。",
                    grammarExamples: "语法示例",
                    close: "关闭",
                    paragraphPracticePlaceholder: (part) => `在此处撰写“${part}”部分的内容...`,
                    downloadAsTxt: "下载为 .txt 文件"
                },
            },
            
            // CONTENT DATA
            content: {
                steps: [
                    {
                        id: 1,
                        titleKey: "step1Title",
                        descKey: "step1Desc",
                        grammars: ["N(이)라는 N", "N에 비해(서)", "A/V-(으)ㄴ/는 반면에", "A/V-(으)ㄹ 정도로"] 
                    },
                    {
                        id: 2,
                        titleKey: "step2Title",
                        descKey: "step2Desc",
                        grammars: ["A/V-(으)ㄹ 뿐만 아니라", "V-다가는", "V-다 보면", "V-는 바람에"] 
                    },
                    {
                        id: 3,
                        titleKey: "step3Title",
                        descKey: "step3Desc",
                        grammars: ["A/V-(으)ㄹ 수밖에 없다", "N은/는 A-다는 것이다", "V-는 대로", "A/V-기는커녕"] 
                    }
                ],
                grammarExamples: {
                    "N(이)라는 N": ["저는 김민준이라는 사람입니다.", "이곳은 '행복'이라는 이름의 카페입니다.", "‘환경보호’라는 주제로 발표를 시작하겠습니다."],
                    "N에 비해(서)": ["작년에 비해 올해 물가가 많이 올랐어요.", "남성에 비해 여성이 주차하는 데 더 오랜 시간이 걸렸습니다.", "가격에 비해 품질이 아주 좋습니다."],
                    "A/V-(으)ㄴ/는 반면에": ["남성은 주차 시간이 짧았던 반면에, 여성은 주차 시간이 매우 길었습니다.", "오늘 날씨는 더운 반면에 바람은 시원하게 불었습니다.", "결과가 뚜렷한 반면에 그 원인은 불분명합니다."],
                    "A/V-(으)ㄹ 정도로": ["결과가 믿기지 않을 정도로 놀라웠습니다.", "두 사람의 실력 차이가 크다고 생각될 정도로 시간 차이가 많이 났습니다.", "주차장의 모든 차가 꽉 찰 정도로 사람이 많았습니다."],
                    "A/V-(으)ㄹ 뿐만 아니라": ["이 실험은 표본이 적을 뿐만 아니라 다른 변수를 통제하지 않았습니다.", "이 음식은 맛이 없을 뿐만 아니라 비싸기까지 합니다.", "비가 올 뿐만 아니라 바람도 심하게 불었습니다."],
                    "V-다가는": ["하나의 결과만 보고 일반화하다가는 편견이 생길 수 있습니다.", "계속 그렇게 과속하다가는 큰 사고가 날 수 있습니다.", "그런 식으로 결론을 내리다가는 큰 오류를 범할 수 있습니다."],
                    "V-다 보면": ["자료를 자세히 분석하다 보면 새로운 사실을 발견할 수 있습니다.", "이 문제를 여러 각도에서 생각하다 보면 더 좋은 해결책이 나올 것입니다.", "매일 꾸준히 연습하다 보면 실력이 늘게 됩니다."],
                    "V-는 바람에": ["실험 참가자가 한 명뿐인 바람에 결과의 신뢰도가 떨어졌습니다.", "갑자기 비가 오는 바람에 약속에 늦었습니다.", "늦잠을 자는 바람에 기차를 놓쳤습니다."],
                    "A/V-(으)ㄹ 수밖에 없다": ["다른 변수를 고려하면 결과는 달라질 수밖에 없습니다.", "증거가 명확해서 그 사실을 인정할 수밖에 없었습니다.", "문제가 복잡해서 신중하게 생각할 수밖에 없습니다."],
                    "N은/는 A-다는 것이다": ["가장 중요한 것은 섣부른 일반화를 피해야 한다는 것이다.", "결론은 성별보다 개인의 경험이 더 중요하다는 것이다.", "문제의 핵심은 표본의 크기가 너무 작다는 것이다."],
                    "V-는 대로": ["분석된 결과를 바탕으로, 있는 그대로 결론을 내려야 합니다.", "조사된 사실을 있는 대로 서술해야 합니다.", "계획한 대로 일이 잘 진행되고 있습니다."],
                    "A/V-기는커녕": ["이 결과는 남녀의 차이를 보여주기는커녕, 성급한 일반화의 위험성을 보여줍니다.", "도와주기는커녕 방해만 됐습니다.", "칭찬은커녕 야단만 맞았습니다."]
                }
            },

            // INITIALIZATION
            init() {
                this.loadData();
                this.cacheDOMElements();
                this.addEventListeners();
                this.render();
            },

            cacheDOMElements() {
                this.dom = {
                    languageSelector: document.getElementById('language-selector'),
                    writingContainer: document.getElementById('writing-container'),
                    downloadContainer: document.getElementById('download-container'),
                    modal: document.getElementById('grammar-modal'),
                    modalTitle: document.getElementById('modal-title'),
                    modalBody: document.getElementById('modal-body'),
                    closeModalBtn: document.getElementById('close-modal'),
                };
            },

            addEventListeners() {
                this.dom.languageSelector.addEventListener('change', (e) => {
                    this.state.currentLanguage = e.target.value;
                    this.saveData();
                    this.render();
                });
                
                this.dom.closeModalBtn.addEventListener('click', () => this.toggleModal(false));
                this.dom.modal.addEventListener('click', (e) => {
                     if (e.target === this.dom.modal) this.toggleModal(false);
                });
            },

            // DATA HANDLING
            saveData() {
                localStorage.setItem('koreanWritingAppData', JSON.stringify(this.state));
            },

            loadData() {
                const data = localStorage.getItem('koreanWritingAppData');
                if (data) {
                    this.state = JSON.parse(data);
                }
            },
            
            // RENDERING LOGIC
            render() {
                this.dom.languageSelector.value = this.state.currentLanguage;
                const T = this.translations[this.state.currentLanguage];
                
                document.title = T.appTitle;
                document.getElementById('app-title').textContent = T.appTitle;

                // Render Topic
                document.getElementById('writing-topic-title').textContent = T.writingTopicTitle;
                document.getElementById('writing-topic-desc').textContent = T.writingTopicDesc;

                // Render Writing Sections
                this.renderWritingSections();
                this.renderDownloadButton();
            },

            renderWritingSections() {
                const T = this.translations[this.state.currentLanguage];
                this.dom.writingContainer.innerHTML = this.content.steps.map(step => {
                    const storageKey = `step_${step.id}`;
                    const savedText = this.state.writings[storageKey] || '';

                    return `
                    <div class="step-section border-t pt-6">
                        <h3 class="text-xl font-bold text-blue-700 mb-2">${T[step.titleKey]}</h3>
                        <p class="text-gray-600 mb-4">${T[step.descKey]}</p>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold mb-2 text-gray-700">${T.practiceGrammar}:</h4>
                            <div class="flex flex-wrap gap-2">
                                ${step.grammars.map(grammar => `
                                    <button class="grammar-btn bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm hover:bg-blue-200" data-grammar="${grammar}">${grammar}</button>
                                `).join('')}
                            </div>
                        </div>

                        <div>
                             <h4 class="font-semibold mb-2 text-gray-700">${T.practiceParagraph}:</h4>
                             <textarea class="practice-textarea w-full h-40 p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" data-step-id="${step.id}" placeholder="${T.paragraphPracticePlaceholder(T[step.titleKey])}">${savedText}</textarea>
                             <div class="text-right mt-2">
                                <button class="save-practice-btn bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700" data-step-id="${step.id}">
                                    <i class="fas fa-save mr-2"></i>${T.save}
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                // Add event listeners to newly created elements
                this.dom.writingContainer.querySelectorAll('.grammar-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.showGrammarModal(btn.dataset.grammar));
                });
                
                this.dom.writingContainer.querySelectorAll('.save-practice-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const stepId = e.currentTarget.dataset.stepId;
                        const textarea = this.dom.writingContainer.querySelector(`.practice-textarea[data-step-id="${stepId}"]`);
                        const text = textarea.value;
                        const storageKey = `step_${stepId}`;

                        if (!this.state.writings) this.state.writings = {};
                        this.state.writings[storageKey] = text;
                        this.saveData();
                        
                        const button = e.currentTarget;
                        button.innerHTML = `<i class="fas fa-check mr-2"></i>${T.saved}`;
                        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        button.classList.add('bg-green-600');
                        setTimeout(() => {
                            button.innerHTML = `<i class="fas fa-save mr-2"></i>${T.save}`;
                            button.classList.remove('bg-green-600');
                            button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        }, 2000);
                        this.renderDownloadButton(); // Update download button state
                    });
                });
            },

            renderDownloadButton() {
                const T = this.translations[this.state.currentLanguage];
                this.dom.downloadContainer.innerHTML = '';
                
                const writings = this.state.writings;
                const hasWritings = writings && Object.values(writings).some(text => text && text.trim() !== '');

                if (hasWritings) {
                    const downloadButton = document.createElement('button');
                    downloadButton.className = "bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700";
                    downloadButton.innerHTML = `<i class="fas fa-download mr-2"></i>${T.downloadAsTxt}`;
                    downloadButton.addEventListener('click', () => this.downloadWritings());
                    this.dom.downloadContainer.appendChild(downloadButton);
                }
            },
            
            downloadWritings() {
                const T = this.translations[this.state.currentLanguage];
                const writings = this.state.writings;
                if (!writings || Object.keys(writings).length === 0) return;

                let content = `${T.writingTopicTitle}\n`;
                content += `================================\n\n`;
                content += `${T.writingTopicDesc}\n\n`;
                content += `================================\n\n`;

                this.content.steps.forEach(step => {
                    const key = `step_${step.id}`;
                    const text = writings[key];
                    if (text) {
                        content += `[ ${T[step.titleKey]} ]\n\n`;
                        content += `${text}\n\n`;
                        content += '--------------------------------\n\n';
                    }
                });
                
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'korean_writing_practice.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            showGrammarModal(grammar) {
                const T = this.translations[this.state.currentLanguage];
                this.dom.modalTitle.textContent = `${T.grammarExamples}: ${grammar}`;
                const examples = this.content.grammarExamples[grammar] || [];
                this.dom.modalBody.innerHTML = `
                    <ul class="list-disc list-inside space-y-2 text-gray-700">
                        ${examples.map(ex => `<li>${ex}</li>`).join('')}
                    </ul>
                `;
                this.toggleModal(true);
            },
            
            toggleModal(show) {
                if (show) {
                    this.dom.modal.classList.remove('hidden');
                } else {
                    this.dom.modal.classList.add('hidden');
                }
            },

            escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            }
        };

        app.init();
    });
    </script>
</body>
</html>

